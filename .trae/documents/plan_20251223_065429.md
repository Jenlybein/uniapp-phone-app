# 系统设计方案

## 一、系统整体架构

### 1. 架构概述
- **前端层**：包含两个客户端应用，vue3-computer（PC端）和vue3-phone（手机端），均基于Vue3开发，手机端使用Uniapp框架
- **后端层**：phone-server，基于Golang+Gin框架，提供RESTful API和WebSocket服务
- **数据层**：MySQL数据库，存储用户信息、消息、图片和AI结果
- **AI服务层**：集成OpenAI API，提供AI对话和图片分析能力

### 2. 架构图
```
┌─────────────────┐     ┌─────────────────┐
│  vue3-computer  │     │   vue3-phone    │
│  (PC端)         │     │  (手机端)       │
└────────┬────────┘     └────────┬────────┘
         │                        │
         └─────────────┬──────────┘
                       │
                 ┌─────┴─────┐
                 │ phone-server │
                 │  (Golang+Gin) │
                 └─────┬─────┘
                       │
         ┌─────────────┴─────────────┐
         │                           │
┌────────▼───────┐           ┌────────▼───────┐
│   MySQL        │           │   OpenAI API   │
│  (phone_db)    │           │                 │
└────────────────┘           └────────────────┘
```

## 二、核心API接口设计

### 1. 用户认证接口
| 路径 | 方法 | 功能 | 请求体 | 响应体 |
|------|------|------|--------|--------|
| `/api/auth/register` | POST | 用户注册 | `{"username": "", "password": "", "email": ""}` | `{"code": 200, "message": "注册成功", "token": ""}` |
| `/api/auth/login` | POST | 用户登录 | `{"username": "", "password": ""}` | `{"code": 200, "message": "登录成功", "token": "", "user": {}}` |
| `/api/auth/refresh` | POST | 刷新Token | `{"token": ""}` | `{"code": 200, "message": "刷新成功", "token": ""}` |

### 2. 消息接口
| 路径 | 方法 | 功能 | 请求体 | 响应体 |
|------|------|------|--------|--------|
| `/api/message` | POST | PC端发送消息给手机端 | `{"content": ""}` | `{"code": 200, "message": "发送成功"}` |
| `/api/image` | POST | PC端发送图片给手机端 | `multipart/form-data: image` | `{"code": 200, "message": "发送成功"}` |
| `/api/ai/chat` | POST | 手机端发送消息给AI | `{"content": "", "type": "text/image"}` | 流式响应AI回复 |

### 3. WebSocket接口
| 路径 | 方法 | 功能 |
|------|------|------|
| `/ws` | GET | 建立WebSocket连接，用于实时消息推送和状态同步 |

## 三、WebSocket推送设计

### 1. 连接管理
- 每个客户端通过WebSocket连接到服务器
- 连接时需携带JWT Token进行身份验证
- 服务器维护用户ID与WebSocket连接的映射关系
- 支持同一用户多端同时在线

### 2. 消息类型
| 类型 | 功能 | 数据格式 |
|------|------|----------|
| `device_status` | 设备状态同步 | `{"type": "device_status", "device_type": "pc/phone", "status": "online/offline", "user_id": ""}` |
| `new_message` | 新消息通知 | `{"type": "new_message", "message": {"id": "", "content": "", "type": "text/image", "sender": "pc/server", "created_at": ""}}` |
| `ai_response` | AI流式回复 | `{"type": "ai_response", "content": "", "message_id": "", "is_finished": false}` |

### 3. 推送策略
- 设备状态变更时，推送至同用户的其他设备
- 新消息到达时，推送至目标设备
- AI回复采用流式推送，逐段返回结果

## 四、MySQL表结构设计

### 1. 用户表（user）
```sql
CREATE TABLE `user` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL UNIQUE COMMENT '用户名',
  `email` varchar(100) NOT NULL UNIQUE COMMENT '邮箱',
  `password_hash` varchar(255) NOT NULL COMMENT '密码哈希',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 2. 设备表（device）
```sql
CREATE TABLE `device` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '设备ID',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID',
  `device_type` enum('pc','phone') NOT NULL COMMENT '设备类型',
  `device_token` varchar(255) NOT NULL COMMENT '设备标识',
  `status` enum('online','offline') NOT NULL DEFAULT 'offline' COMMENT '设备状态',
  `last_active_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '最后活跃时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  CONSTRAINT `fk_device_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备表';
```

### 3. 消息表（message）
```sql
CREATE TABLE `message` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '消息ID',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID',
  `type` enum('text','image') NOT NULL COMMENT '消息类型',
  `content` text NOT NULL COMMENT '消息内容（文本或图片URL）',
  `sender` enum('pc','server') NOT NULL COMMENT '发送者',
  `is_selected` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否被手机端选择',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  CONSTRAINT `fk_message_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息表';
```

### 4. AI结果表（ai_result）
```sql
CREATE TABLE `ai_result` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '结果ID',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID',
  `message_id` bigint unsigned NOT NULL COMMENT '关联的消息ID',
  `content` text NOT NULL COMMENT 'AI回复内容',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_message_id` (`message_id`),
  CONSTRAINT `fk_ai_result_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_ai_result_message` FOREIGN KEY (`message_id`) REFERENCES `message` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='AI结果表';
```

## 五、关键业务时序

### 1. 用户注册流程
1. 客户端（PC/手机）提交注册信息
2. 后端验证信息合法性，生成密码哈希
3. 后端将用户信息存入数据库
4. 后端生成JWT Token返回给客户端
5. 客户端保存Token，完成注册

### 2. 设备状态同步流程
1. 客户端连接WebSocket，发送Token进行身份验证
2. 服务器验证Token，获取用户ID
3. 服务器更新设备状态为在线
4. 服务器向同用户的其他设备推送设备状态变更消息
5. 客户端收到状态变更消息，更新UI显示

### 3. PC端发送消息到手机端流程
1. PC端调用 `/api/message` 接口，携带JWT Token
2. 后端验证Token，获取用户ID
3. 后端将消息存入数据库
4. 后端通过WebSocket向同用户的手机端推送新消息
5. 手机端收到消息，显示在上半屏选项框内

### 4. 手机端发送消息到AI流程
1. 手机端选择消息或图片，发送到 `/api/ai/chat` 接口
2. 后端验证Token，获取用户ID
3. 后端将消息存入数据库，标记为已选择
4. 后端调用OpenAI API，请求AI回复
5. 后端通过WebSocket流式推送AI回复到手机端
6. 手机端收到流式回复，显示在下半屏内容框内
7. AI回复完成后，后端将完整结果存入数据库

## 六、OpenAI调用示例

```go
// 文本对话调用示例
func (s *AIService) ChatWithText(ctx context.Context, content string, streamCallback func(chunk string) error) error {
    reqBody := map[string]interface{}{
        "model": s.model,
        "messages": []map[string]string{
            {"role": "user", "content": content},
        },
        "stream": true,
    }
    
    // 发送请求并处理流式响应
    // ...
    
    return nil
}

// 图片分析调用示例
func (s *AIService) ChatWithImage(ctx context.Context, imageBase64 string, prompt string, streamCallback func(chunk string) error) error {
    reqBody := map[string]interface{}{
        "model": s.model,
        "messages": []map[string]interface{}{
            {
                "role": "user",
                "content": []map[string]string{
                    {"type": "text", "text": prompt},
                    {"type": "image_url", "image_url": map[string]string{"url": imageBase64}},
                },
            },
        },
        "stream": true,
    }
    
    // 发送请求并处理流式响应
    // ...
    
    return nil
}
```

## 七、可扩展性与风险点

### 1. 可扩展性
- **模块化设计**：后端采用分层架构，业务逻辑与数据访问分离，便于扩展新功能
- **微服务潜力**：核心功能可拆分为用户服务、消息服务、AI服务等微服务
- **多AI提供商支持**：设计抽象AI服务接口，便于切换或集成多个AI提供商
- **水平扩展**：WebSocket服务支持集群部署，通过Redis等实现跨节点消息推送

### 2. 风险点
- **WebSocket连接管理**：需要妥善处理连接断开、重连机制，避免内存泄漏
- **AI服务依赖**：OpenAI API调用可能出现延迟或故障，需实现重试机制和降级策略
- **数据安全**：敏感数据（如密码）需加密存储，JWT Token需设置合理过期时间
- **并发处理**：多端并发操作时，需确保数据一致性，采用适当的锁机制
- **流量控制**：需要限制API调用频率，防止恶意请求或资源耗尽

## 八、实现计划

1. **数据库初始化**：创建所需表结构
2. **后端扩展**：
   - 添加用户认证模块
   - 扩展WebSocket功能，支持多端状态同步
   - 实现消息存储和查询
   - 完善AI调用和流式输出
3. **前端开发**：
   - 添加登录、注册页面
   - 实现设备状态显示
   - 完善消息发送和接收功能
   - 实现AI回复流式显示
4. **联调测试**：
   - 测试多端状态同步
   - 测试消息和图片发送接收
   - 测试AI流式回复
   - 测试用户认证和权限校验

## 九、技术栈与依赖

| 组件 | 技术栈 | 主要依赖 |
|------|--------|----------|
| 后端 | Golang | Gin, GORM, JWT, Gorilla WebSocket, OpenAI Go SDK |
| 前端(PC) | Vue3+TypeScript | Vite, Axios, Vue Router, Pinia |
| 前端(手机) | Uniapp+Vue3 | UniUI, Axios |
| 数据库 | MySQL | - |
| AI服务 | OpenAI API | - |

## 十、安全考虑

1. **认证与授权**：采用JWT Token进行身份验证，权限校验
2. **数据加密**：密码使用bcrypt哈希存储，敏感数据传输采用HTTPS
3. **输入验证**：所有API请求参数进行严格验证，防止注入攻击
4. **跨域处理**：合理配置CORS策略，限制跨域请求
5. **日志审计**：记录关键操作日志，便于故障排查和安全审计
6. **速率限制**：对API调用进行速率限制，防止恶意请求

以上设计方案满足了用户的所有需求，包括多端消息传输、AI交互、设备状态同步、用户认证等功能，同时考虑了系统的可扩展性、安全性和可靠性。