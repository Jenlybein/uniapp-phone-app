<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket测试页面</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .connection-status {
        padding: 10px;
        border-radius: 5px;
        font-weight: bold;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
      .messages {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
        background-color: #f5f5f5;
      }
      .message {
        margin: 5px 0;
        padding: 8px;
        border-radius: 3px;
      }
      .user-message {
        background-color: #e3f2fd;
        text-align: right;
      }
      .ai-message {
        background-color: #fff3e0;
      }
      .input-area {
        display: flex;
        gap: 10px;
      }
      input[type="text"] {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      button {
        padding: 10px 20px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      button:hover {
        background-color: #45a049;
      }
      .image-upload {
        margin-top: 10px;
      }
      #imagePreview {
        max-width: 200px;
        max-height: 200px;
        margin-top: 10px;
        display: none;
      }
      .api-info {
        background-color: #f0f8ff;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>WebSocket AI服务测试</h1>

      <div class="connection-status disconnected" id="connectionStatus">
        未连接
      </div>

      <div class="messages" id="messages">
        <!-- 消息将显示在这里 -->
      </div>

      <div>
        <div class="input-area">
          <input
            type="text"
            id="messageInput"
            placeholder="输入消息..."
            disabled
          />
          <button id="sendBtn" disabled>发送</button>
        </div>

        <div class="image-upload">
          <input type="file" id="imageInput" accept="image/*" disabled />
          <button id="sendImageBtn" disabled>发送图片</button>
          <img id="imagePreview" alt="图片预览" />
        </div>
      </div>

      <div class="api-info">
        <h3>API信息</h3>
        <p><strong>健康检查:</strong> GET http://localhost:8080/api/health</p>
        <p><strong>发送文本:</strong> POST http://localhost:8080/api/message</p>
        <p><strong>发送图片:</strong> POST http://localhost:8080/api/image</p>
        <p>
          <strong>WebSocket:</strong> ws://localhost:8080/ws 或
          ws://localhost:8080
        </p>
      </div>
    </div>

    <script>
      let ws;
      let imageData = null;
      let heartbeatInterval;
      let reconnectTimeout;
      let isConnecting = false;
      const reconnectDelay = 3000;
      const heartbeatDelay = 30000; // 30秒心跳

      // 连接WebSocket
      function connectWebSocket() {
        if (isConnecting) return;
        isConnecting = true;

        const wsUrl = "ws://localhost:8080/ws";
        ws = new WebSocket(wsUrl);

        ws.onopen = function () {
          console.log("WebSocket连接已建立");
          document.getElementById("connectionStatus").className =
            "connection-status connected";
          document.getElementById("connectionStatus").textContent = "已连接";
          document.getElementById("messageInput").disabled = false;
          document.getElementById("sendBtn").disabled = false;
          document.getElementById("imageInput").disabled = false;
          document.getElementById("sendImageBtn").disabled = false;
          addMessage("系统", "WebSocket连接已建立", "ai-message");
          isConnecting = false;

          // 启动心跳
          startHeartbeat();
        };

        ws.onmessage = function (event) {
          console.log("收到消息:", event.data);
          try {
            const message = JSON.parse(event.data);
            if (message.type === "text") {
              addMessage("AI", message.content, "ai-message");
            }
          } catch (error) {
            console.error("解析消息失败:", error);
            addMessage("系统", "收到无效消息格式", "ai-message");
          }
        };

        ws.onerror = function (error) {
          console.error("WebSocket错误:", error);
        };

        ws.onclose = function (event) {
          console.log("WebSocket连接已关闭:", event.code, event.reason);
          document.getElementById("connectionStatus").className =
            "connection-status disconnected";
          document.getElementById("connectionStatus").textContent = "未连接";
          document.getElementById("messageInput").disabled = true;
          document.getElementById("sendBtn").disabled = true;
          document.getElementById("imageInput").disabled = true;
          document.getElementById("sendImageBtn").disabled = true;
          addMessage("系统", "WebSocket连接已关闭", "ai-message");
          isConnecting = false;

          // 停止心跳
          stopHeartbeat();

          // 尝试重连
          reconnect();
        };
      }

      // 启动心跳
      function startHeartbeat() {
        stopHeartbeat(); // 先停止可能存在的心跳
        heartbeatInterval = setInterval(function () {
          if (ws && ws.readyState === WebSocket.OPEN) {
            try {
              // 发送心跳消息
              ws.send(JSON.stringify({ type: "ping" }));
              console.log("发送心跳");
            } catch (error) {
              console.error("发送心跳失败:", error);
              reconnect();
            }
          }
        }, heartbeatDelay);
      }

      // 停止心跳
      function stopHeartbeat() {
        if (heartbeatInterval) {
          clearInterval(heartbeatInterval);
          heartbeatInterval = null;
        }
      }

      // 重连机制
      function reconnect() {
        if (reconnectTimeout) {
          clearTimeout(reconnectTimeout);
        }
        reconnectTimeout = setTimeout(function () {
          console.log("尝试重新连接WebSocket");
          connectWebSocket();
        }, reconnectDelay);
      }

      // 添加消息到消息列表
      function addMessage(sender, content, className) {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${className}`;
        messageDiv.innerHTML = `<strong>${sender}:</strong> ${content}`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // 发送文本消息
      function sendTextMessage() {
        const input = document.getElementById("messageInput");
        const content = input.value.trim();
        if (content && ws && ws.readyState === WebSocket.OPEN) {
          try {
            const message = JSON.stringify({
              type: "text",
              content: content,
            });
            ws.send(message);
            addMessage("你", content, "user-message");
            input.value = "";
          } catch (error) {
            console.error("发送消息失败:", error);
            addMessage("系统", "发送消息失败，请检查网络连接", "ai-message");
          }
        } else {
          addMessage("系统", "连接已断开，正在重连...", "ai-message");
          reconnect();
        }
      }

      // 图片转base64
      function imageToBase64(file, callback) {
        const reader = new FileReader();
        reader.onload = function (e) {
          callback(e.target.result.split(",")[1]); // 移除base64前缀
        };
        reader.readAsDataURL(file);
      }

      // 发送图片消息
      function sendImageMessage() {
        if (imageData && ws && ws.readyState === WebSocket.OPEN) {
          try {
            const message = JSON.stringify({
              type: "image",
              content: imageData,
            });
            ws.send(message);
            addMessage("你", "[发送了一张图片]", "user-message");
            // 清空图片预览
            document.getElementById("imagePreview").style.display = "none";
            document.getElementById("imageInput").value = "";
            imageData = null;
          } catch (error) {
            console.error("发送图片失败:", error);
            addMessage("系统", "发送图片失败，请检查网络连接", "ai-message");
          }
        } else {
          addMessage("系统", "连接已断开，正在重连...", "ai-message");
          reconnect();
        }
      }

      // 图片选择事件
      document
        .getElementById("imageInput")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            // 预览图片
            const reader = new FileReader();
            reader.onload = function (e) {
              const preview = document.getElementById("imagePreview");
              preview.src = e.target.result;
              preview.style.display = "block";
            };
            reader.readAsDataURL(file);

            // 转换为base64
            imageToBase64(file, function (base64) {
              imageData = base64;
            });
          }
        });

      // 发送按钮事件
      document
        .getElementById("sendBtn")
        .addEventListener("click", sendTextMessage);

      // 发送图片按钮事件
      document
        .getElementById("sendImageBtn")
        .addEventListener("click", sendImageMessage);

      // 回车键发送消息
      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendTextMessage();
          }
        });

      // 页面加载时连接WebSocket
      window.addEventListener("load", connectWebSocket);
    </script>
  </body>
</html>
